# =============================================================================
# Scenario B: AWS Secrets Manager with External Secrets Operator (ESO)
# =============================================================================
# This deployment demonstrates how to use AWS Secrets Manager with the
# External Secrets Operator (ESO) to sync secrets to Kubernetes.
#
# How it works:
# 1. ESO watches for ExternalSecret custom resources
# 2. It fetches secrets from AWS Secrets Manager
# 3. Creates/updates native Kubernetes Secrets
# 4. Application uses secrets as environment variables or mounted files
#
# Pros:
# - Native K8s Secret integration
# - Automatic rotation sync
# - Supports multiple backends (AWS, Vault, GCP, Azure)
# - No CSI driver needed
#
# Cons:
# - $0.40/secret/month cost
# - Requires ESO operator installation
# - Sync interval introduces potential staleness
# =============================================================================

# -----------------------------------------------------------------------------
# Service Account with IRSA
# -----------------------------------------------------------------------------

apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-secrets-manager
  namespace: apps
  annotations:
    eks.amazonaws.com/role-arn: "${SECRETS_MANAGER_ROLE_ARN}"
  labels:
    app.kubernetes.io/name: finance-api
    app.kubernetes.io/component: api
    app.kubernetes.io/scenario: secrets-manager

---
# -----------------------------------------------------------------------------
# SecretStore - ESO connection to AWS Secrets Manager
# -----------------------------------------------------------------------------
# This defines how ESO authenticates to AWS Secrets Manager.
# We use IRSA (IAM Roles for Service Accounts) for secure authentication.
# -----------------------------------------------------------------------------

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: apps
spec:
  provider:
    aws:
      service: SecretsManager
      region: "${AWS_REGION}"
      auth:
        jwt:
          serviceAccountRef:
            name: app-secrets-manager

---
# -----------------------------------------------------------------------------
# ExternalSecret - Database Credentials
# -----------------------------------------------------------------------------
# This tells ESO which secret to fetch and how to create the K8s Secret.
# -----------------------------------------------------------------------------

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-credentials
  namespace: apps
  labels:
    app.kubernetes.io/name: finance-api
    app.kubernetes.io/scenario: secrets-manager
spec:
  # How often to sync the secret
  refreshInterval: 1m
  
  # Reference to the SecretStore
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  
  # Target Kubernetes Secret configuration
  target:
    name: db-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: finance-api
          app.kubernetes.io/scenario: secrets-manager
      data:
        # Template the connection string from JSON fields
        DB_CONNECTION_STRING: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .dbname }}?sslmode=require"
  
  # Data to fetch from AWS Secrets Manager
  data:
    - secretKey: username
      remoteRef:
        key: "${PROJECT_NAME}/database/credentials"
        property: username
    - secretKey: password
      remoteRef:
        key: "${PROJECT_NAME}/database/credentials"
        property: password
    - secretKey: host
      remoteRef:
        key: "${PROJECT_NAME}/database/credentials"
        property: host
    - secretKey: port
      remoteRef:
        key: "${PROJECT_NAME}/database/credentials"
        property: port
    - secretKey: dbname
      remoteRef:
        key: "${PROJECT_NAME}/database/credentials"
        property: dbname

---
# -----------------------------------------------------------------------------
# ExternalSecret - API Credentials
# -----------------------------------------------------------------------------

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-credentials
  namespace: apps
  labels:
    app.kubernetes.io/name: finance-api
    app.kubernetes.io/scenario: secrets-manager
spec:
  refreshInterval: 1m
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: api-credentials
    creationPolicy: Owner
  data:
    - secretKey: API_KEY
      remoteRef:
        key: "${PROJECT_NAME}/api/credentials"
        property: api_key
    - secretKey: API_SECRET
      remoteRef:
        key: "${PROJECT_NAME}/api/credentials"
        property: api_secret

---
# -----------------------------------------------------------------------------
# ConfigMap - Non-sensitive configuration
# -----------------------------------------------------------------------------

apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config-secrets-manager
  namespace: apps
  labels:
    app.kubernetes.io/name: finance-api
    app.kubernetes.io/scenario: secrets-manager
data:
  SECRET_SOURCE: "env"
  PORT: "8080"
  LOG_LEVEL: "INFO"
  ENABLE_SECRET_DEBUG: "false"

---
# -----------------------------------------------------------------------------
# Deployment
# -----------------------------------------------------------------------------

apiVersion: apps/v1
kind: Deployment
metadata:
  name: finance-api-secrets-manager
  namespace: apps
  labels:
    app.kubernetes.io/name: finance-api
    app.kubernetes.io/component: api
    app.kubernetes.io/scenario: secrets-manager
    app.kubernetes.io/version: "1.0.0"
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: finance-api
      app.kubernetes.io/scenario: secrets-manager
  template:
    metadata:
      labels:
        app.kubernetes.io/name: finance-api
        app.kubernetes.io/component: api
        app.kubernetes.io/scenario: secrets-manager
      annotations:
        # Checksum of secrets - forces restart on secret change
        checksum/db-credentials: "{{ include (print $.Template.BasePath \"/db-credentials.yaml\") . | sha256sum }}"
    spec:
      serviceAccountName: app-secrets-manager
      
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      
      containers:
        - name: app
          image: "${ECR_REGISTRY}/finance-api:1.0.0"
          imagePullPolicy: Always
          
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          
          # Environment from ConfigMap
          envFrom:
            - configMapRef:
                name: app-config-secrets-manager
          
          # Environment from K8s Secrets (synced by ESO)
          env:
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: host
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: port
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: dbname
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-credentials
                  key: password
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-credentials
                  key: API_KEY
          
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 15
          
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
      
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfied: ScheduleAnyway
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: finance-api
              app.kubernetes.io/scenario: secrets-manager

---
# -----------------------------------------------------------------------------
# Service
# -----------------------------------------------------------------------------

apiVersion: v1
kind: Service
metadata:
  name: finance-api-secrets-manager
  namespace: apps
  labels:
    app.kubernetes.io/name: finance-api
    app.kubernetes.io/scenario: secrets-manager
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: finance-api
    app.kubernetes.io/scenario: secrets-manager

---
# -----------------------------------------------------------------------------
# Horizontal Pod Autoscaler
# -----------------------------------------------------------------------------

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: finance-api-secrets-manager
  namespace: apps
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: finance-api-secrets-manager
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

---
# -----------------------------------------------------------------------------
# Pod Disruption Budget
# -----------------------------------------------------------------------------

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: finance-api-secrets-manager
  namespace: apps
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: finance-api
      app.kubernetes.io/scenario: secrets-manager

# =============================================================================
# Approach 2: AWS Parameter Store with Secrets Store CSI Driver
# =============================================================================
# This demonstrates using the Secrets Store CSI Driver to mount secrets
# directly from AWS Parameter Store as files in the pod
#
# Benefits:
# - Secrets mounted as files (no env vars needed)
# - Automatic rotation via CSI driver
# - Works with both Secrets Manager and Parameter Store
# - Direct integration without intermediate Kubernetes Secrets
# =============================================================================

# SecretProviderClass - Defines which secrets to fetch from AWS
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: aws-param-store-secrets
  namespace: demo
spec:
  provider: aws
  parameters:
    region: us-east-1
    objects: |
      - objectName: "/secrets-mgmt-dev/database/password"
        objectType: "ssmparameter"
        objectAlias: "db-password"
      - objectName: "/secrets-mgmt-dev/api/key"
        objectType: "ssmparameter"
        objectAlias: "api-key"
      - objectName: "/secrets-mgmt-dev/database/connection-string"
        objectType: "ssmparameter"
        objectAlias: "db-connection-string"
  # Optionally sync to a Kubernetes Secret as well
  secretObjects:
    - secretName: param-store-secrets
      type: Opaque
      data:
        - objectName: "db-password"
          key: DB_PASSWORD
        - objectName: "api-key"
          key: API_KEY
        - objectName: "db-connection-string"
          key: DATABASE_URL
---
# SecretProviderClass for Secrets Manager (alternative)
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: aws-secrets-manager-secrets
  namespace: demo
spec:
  provider: aws
  parameters:
    region: us-east-1
    objects: |
      - objectName: "secrets-mgmt-dev/database/credentials"
        objectType: "secretsmanager"
        objectAlias: "database-credentials"
        jmesPath:
          - path: "username"
            objectAlias: "db-username"
          - path: "password"
            objectAlias: "db-password"
          - path: "host"
            objectAlias: "db-host"
      - objectName: "secrets-mgmt-dev/api/credentials"
        objectType: "secretsmanager"
        objectAlias: "api-credentials"
        jmesPath:
          - path: "api_key"
            objectAlias: "api-key"
          - path: "api_secret"
            objectAlias: "api-secret"
  secretObjects:
    - secretName: secrets-manager-csi-secrets
      type: Opaque
      data:
        - objectName: "db-username"
          key: DB_USER
        - objectName: "db-password"
          key: DB_PASSWORD
        - objectName: "db-host"
          key: DB_HOST
        - objectName: "api-key"
          key: API_KEY
        - objectName: "api-secret"
          key: API_SECRET

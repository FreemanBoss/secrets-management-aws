# =============================================================================
# HashiCorp Vault - Helm Values
# =============================================================================
# This configures HashiCorp Vault for Kubernetes deployment.
# Includes both Vault server and Vault Agent Injector configuration.
#
# Documentation: https://developer.hashicorp.com/vault/docs/platform/k8s/helm
# =============================================================================

global:
  # Enable TLS everywhere
  tlsDisable: false

# =============================================================================
# Vault Agent Injector Configuration
# =============================================================================
# The injector automatically injects Vault Agent sidecars into pods.

injector:
  enabled: true
  replicas: 2
  
  # Leader election
  leaderElector:
    enabled: true
  
  # Metrics
  metrics:
    enabled: true
  
  # Agent configuration defaults
  agentDefaults:
    cpuLimit: "500m"
    cpuRequest: "50m"
    memLimit: "128Mi"
    memRequest: "64Mi"
    template: "map"
    templateConfig:
      exitOnRetryFailure: true
      staticSecretRenderInterval: "60s"
  
  # Image
  image:
    repository: hashicorp/vault-k8s
    tag: 1.5.0
    pullPolicy: IfNotPresent
  
  # Agent image
  agentImage:
    repository: hashicorp/vault
    tag: 1.18.3
  
  # Resources
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 256Mi
  
  # Pod disruption budget
  podDisruptionBudget:
    minAvailable: 1
  
  # Affinity
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: vault-agent-injector
            topologyKey: kubernetes.io/hostname
  
  # Webhook configuration
  webhook:
    failurePolicy: Ignore
    matchPolicy: Exact
    timeoutSeconds: 30

# =============================================================================
# Vault Server Configuration
# =============================================================================

server:
  enabled: true
  
  # Enterprise license (leave empty for community)
  enterpriseLicense:
    secretName: ""
    secretKey: "license"
  
  # Image
  image:
    repository: hashicorp/vault
    tag: 1.18.3
    pullPolicy: IfNotPresent
  
  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Readiness probe
  readinessProbe:
    enabled: true
    path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"
  
  # Liveness probe
  livenessProbe:
    enabled: true
    path: "/v1/sys/health?standbyok=true"
    initialDelaySeconds: 60
  
  # Audit storage
  auditStorage:
    enabled: true
    size: 10Gi
    storageClass: gp3
    accessMode: ReadWriteOnce
  
  # Data storage
  dataStorage:
    enabled: true
    size: 10Gi
    storageClass: gp3
    accessMode: ReadWriteOnce
  
  # Standalone mode (for dev/testing)
  standalone:
    enabled: false
  
  # HA Mode configuration
  ha:
    enabled: true
    replicas: 3
    
    # Raft storage backend (recommended for K8s)
    raft:
      enabled: true
      setNodeId: true
      
      config: |
        ui = true
        
        listener "tcp" {
          tls_disable = 0
          address = "[::]:8200"
          cluster_address = "[::]:8201"
          tls_cert_file = "/vault/tls/tls.crt"
          tls_key_file = "/vault/tls/tls.key"
          tls_client_ca_file = "/vault/tls/ca.crt"
        }
        
        storage "raft" {
          path = "/vault/data"
          
          retry_join {
            leader_api_addr = "https://vault-0.vault-internal:8200"
            leader_ca_cert_file = "/vault/tls/ca.crt"
          }
          retry_join {
            leader_api_addr = "https://vault-1.vault-internal:8200"
            leader_ca_cert_file = "/vault/tls/ca.crt"
          }
          retry_join {
            leader_api_addr = "https://vault-2.vault-internal:8200"
            leader_ca_cert_file = "/vault/tls/ca.crt"
          }
        }
        
        seal "awskms" {
          region     = "us-east-1"
          kms_key_id = "${KMS_KEY_ID}"
        }
        
        service_registration "kubernetes" {}
        
        telemetry {
          prometheus_retention_time = "30s"
          disable_hostname = true
        }
    
    # Disable Raft for Consul backend (alternative)
    # config: |
    #   ui = true
    #   storage "consul" {
    #     path = "vault"
    #     address = "consul-server:8500"
    #   }
  
  # Service account
  serviceAccount:
    create: true
    annotations:
      eks.amazonaws.com/role-arn: "${VAULT_ROLE_ARN}"
  
  # Extra containers (optional - for metrics)
  extraContainers: []
  
  # Pod annotations
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8200"
    prometheus.io/path: "/v1/sys/metrics"
  
  # Pod disruption budget
  podDisruptionBudget:
    minAvailable: 1
  
  # Affinity
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: vault
              component: server
          topologyKey: topology.kubernetes.io/zone
  
  # Node selector for dedicated nodes (optional)
  # nodeSelector:
  #   dedicated: vault
  
  # Tolerations for dedicated nodes (optional)
  # tolerations:
  #   - key: "dedicated"
  #     operator: "Equal"
  #     value: "vault"
  #     effect: "NoSchedule"
  
  # Ingress (optional - enable for external access)
  ingress:
    enabled: false
    # ingressClassName: nginx
    # hosts:
    #   - host: vault.example.com
    #     paths: []
    # tls:
    #   - secretName: vault-tls
    #     hosts:
    #       - vault.example.com

# =============================================================================
# Vault UI Configuration
# =============================================================================

ui:
  enabled: true
  serviceType: ClusterIP
  externalPort: 8200

# =============================================================================
# CSI Provider (alternative to Agent Injector)
# =============================================================================

csi:
  enabled: false  # We're using Agent Injector instead

# =============================================================================
# Server Telemetry (Prometheus)
# =============================================================================

serverTelemetry:
  serviceMonitor:
    enabled: true
    selectors: {}
    interval: 30s
    scrapeTimeout: 10s
  prometheusRules:
    enabled: false
